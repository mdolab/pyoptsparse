os:
- linux

language: generic

services:
  - docker
env:
  global:
    - REPO_NAME=pyoptsparse
    - DOCKER_WORKING_DIR=/home/mdolabuser/packages/$REPO_NAME
    - DOCKER_MOUNT_DIR=/home/mdolabuser/travis/$REPO_NAME
    - SNOPT_DIR=$DOCKER_WORKING_DIR/pyoptsparse/pySNOPT/source
    - NLPQLP_DIR=$DOCKER_WORKING_DIR/pyoptsparse/pyNLPQLP/source
    - IPOPT_DIR=$DOCKER_WORKING_DIR/pyoptsparse/pyIPOPT/Ipopt
  jobs:
    - DOCKER_TAG=current

before_install:  
- if [ "$TRAVIS_PULL_REQUEST" != "false" ]; then
    export DOCKER_REPO=public
  else
    export DOCKER_REPO=opt
    # extra step for login to Docker using Travis encrypted credentials
    echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  fi
- docker pull mdolab/$DOCKER_REPO:$DOCKER_TAG
# run Docker, key is we mount the current Travis directory into Docker to access content of repo
- docker run -t -d 
        --name app
        --mount "type=bind,src=$(pwd),target=$DOCKER_MOUNT_DIR"
        mdolab/$DOCKER_REPO:$DOCKER_TAG
        /bin/bash

install:
  # We back up the proprietary source codes first
  - docker exec -it app /bin/bash -c "cp -r $SNOPT_DIR \$HOME/SNOPT && cp -r $NLPQLP_DIR \$HOME/NLPQLP && cp -r $IPOPT_DIR \$HOME/IPOPT"
  # We thrown away the existing repo in Docker, and copy the new one in-place
  - docker exec -it app /bin/bash -c "rm -rf $DOCKER_WORKING_DIR && cp -r $DOCKER_MOUNT_DIR $DOCKER_WORKING_DIR"
  - docker exec -it app /bin/bash -c "cp -r \$HOME/NLPQLP/* $NLPQLP_DIR/ && cp -r \$HOME/SNOPT/* $SNOPT_DIR/ && cp -r \$HOME/IPOPT/ $IPOPT_DIR"
  - docker exec -it app /bin/bash -c ". \$HOME/.bashrc_mdolab && cd $DOCKER_WORKING_DIR && python setup.py build_ext --inplace && python setup.py install --user"
script:
  # We need to source the mdolab bashrc before running anything
  - docker exec -it app /bin/bash -c ". \$HOME/.bashrc_mdolab && cd $DOCKER_WORKING_DIR && testflo -n 1 -v . --coverage --coverpkg pyoptsparse --cover-omit \*tests/\* --cover-omit \*docs/\*"

after_script:
  - docker rm -f app
